<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHACHA ASLAM SEARCH</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f7fa; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #1a237e, #283593); color: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        h1 { font-size: 28px; margin-bottom: 10px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-number { font-size: 32px; font-weight: bold; color: #1a237e; }
        .search-box { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .search-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        input[type="text"] { flex: 1; min-width: 300px; padding: 12px 15px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; }
        select { padding: 12px 15px; border: 2px solid #ddd; border-radius: 6px; background: white; min-width: 200px; }
        button { padding: 12px 25px; background: #1a237e; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; }
        button:hover { background: #283593; }
        .clear-btn { background: #757575; }
        .search-options { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; }
        .options-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .option { display: flex; align-items: center; gap: 8px; }
        .table-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #3f51b5; color: white; padding: 15px; text-align: left; position: sticky; top: 0; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f5f5f5; }
        .loading { display: none; text-align: center; padding: 40px; }
        .loading.active { display: block; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1a237e; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-results { text-align: center; padding: 60px 20px; display: none; }
        .highlight { background: yellow; padding: 2px; border-radius: 2px; font-weight: bold; }
        @media (max-width: 768px) {
            .search-row { flex-direction: column; }
            input[type="text"], select, button { width: 100%; min-width: unset; }
            th, td { padding: 10px; font-size: 14px; }
            .options-row { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CHACHA ASLAM SEARCH</h1>
            <p>Search 34,000+ records with exact matching</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalRecords">0</div>
                <div>Total Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="searchCount">0</div>
                <div>Search Results</div>
            </div>
        </div>
        
        <div class="search-box">
            <div class="search-row">
                <input type="text" id="searchInput" placeholder="Search by Application No, Name, CHAK, or Clerk...">
                <select id="searchColumn">
                    <option value="all">All Columns</option>
                </select>
                <button id="searchBtn">Search</button>
                <button id="clearBtn" class="clear-btn">Clear</button>
            </div>
            
            <div class="search-options">
                <div class="options-row">
                    <div class="option">
                        <input type="checkbox" id="exactMatch" checked>
                        <label for="exactMatch"><strong>Exact Match</strong> (only "41", not "1412")</label>
                    </div>
                    <div class="option">
                        <input type="checkbox" id="wholeWord" checked>
                        <label for="wholeWord"><strong>Whole Word</strong> (match complete words)</label>
                    </div>
                    <div class="option">
                        <input type="checkbox" id="caseSensitive">
                        <label for="caseSensitive"><strong>Case Sensitive</strong></label>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 15px; color: #666; font-weight: bold;">
                Found <span id="resultsCount">0</span> record(s)
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Loading data...</div>
        </div>
        
        <div class="table-container">
            <table id="resultsTable">
                <thead></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <div class="no-results" id="noResults">
            <h3>No Records Found</h3>
            <p>Try a different search term</p>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw_n6OI0kd4z19Hvn2rpUp7DsyAPde2jbQDM-qJzBk_wJhp9lcSOgnh42aD8DJrRITjNw/exec';
        let allData = [];
        let columns = [];
        
        async function init() {
            showLoading();
            
            try {
                // Load columns
                const colsRes = await fetch(WEB_APP_URL + '?action=getColumns');
                const colsData = await colsRes.json();
                columns = colsData.columns.filter(c => !c.toLowerCase().includes('timestamp'));
                
                // Update dropdown
                const select = document.getElementById('searchColumn');
                select.innerHTML = '<option value="all">All Columns</option>';
                columns.forEach(col => {
                    const option = document.createElement('option');
                    option.value = col;
                    option.textContent = col;
                    select.appendChild(option);
                });
                
                // Update table headers
                const thead = document.querySelector('#resultsTable thead');
                thead.innerHTML = '<tr>' + columns.map(c => `<th>${c}</th>`).join('') + '</tr>';
                
                // Load initial data
                await loadAllData();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load data');
            } finally {
                hideLoading();
            }
        }
        
        async function loadAllData() {
            try {
                const res = await fetch(WEB_APP_URL + '?action=getAll');
                const data = await res.json();
                allData = data.data || [];
                
                // Display all data initially
                performSearch();
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const column = document.getElementById('searchColumn').value;
            const exactMatch = document.getElementById('exactMatch').checked;
            const wholeWord = document.getElementById('wholeWord').checked;
            const caseSensitive = document.getElementById('caseSensitive').checked;
            
            if (!searchTerm) {
                displayResults(allData);
                updateCounts(allData.length);
                return;
            }
            
            // Filter data based on search options
            let results = allData.filter(record => {
                if (column === 'all') {
                    // Search in all columns
                    for (let col of columns) {
                        const value = String(record[col] || '');
                        if (matchValue(value, searchTerm, exactMatch, wholeWord, caseSensitive)) {
                            return true;
                        }
                    }
                    return false;
                } else {
                    // Search in specific column
                    const value = String(record[column] || '');
                    return matchValue(value, searchTerm, exactMatch, wholeWord, caseSensitive);
                }
            });
            
            displayResults(results);
            updateCounts(results.length);
        }
        
        function matchValue(value, searchTerm, exactMatch, wholeWord, caseSensitive) {
            let searchText = caseSensitive ? searchTerm : searchTerm.toLowerCase();
            let cellValue = caseSensitive ? value : value.toLowerCase();
            
            if (exactMatch) {
                // EXACT MATCH: "41" only matches "41", not "1412"
                // Split by spaces and check each word
                const words = cellValue.split(/\s+/);
                return words.some(word => word === searchText);
            } else if (wholeWord) {
                // WHOLE WORD MATCH: "41" matches "41 DNB" but not "1412"
                // Using word boundaries in regex
                const escapedSearch = searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`\\b${escapedSearch}\\b`, caseSensitive ? '' : 'i');
                return regex.test(value); // Use original value for regex
            } else {
                // SUBSTRING MATCH (original behavior): "41" matches anything with "41"
                return cellValue.includes(searchText);
            }
        }
        
        function displayResults(data) {
            const tbody = document.getElementById('tableBody');
            const searchTerm = document.getElementById('searchInput').value;
            const exactMatch = document.getElementById('exactMatch').checked;
            const wholeWord = document.getElementById('wholeWord').checked;
            const caseSensitive = document.getElementById('caseSensitive').checked;
            
            if (!data.length) {
                document.querySelector('.table-container').style.display = 'none';
                document.getElementById('noResults').style.display = 'block';
                return;
            }
            
            document.querySelector('.table-container').style.display = 'block';
            document.getElementById('noResults').style.display = 'none';
            
            let html = '';
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col] || '';
                    
                    // Highlight the search term if found
                    if (searchTerm) {
                        if (exactMatch) {
                            // Highlight exact word matches
                            const words = value.split(/\s+/);
                            value = words.map(word => {
                                const isMatch = caseSensitive 
                                    ? word === searchTerm
                                    : word.toLowerCase() === searchTerm.toLowerCase();
                                return isMatch ? `<span class="highlight">${word}</span>` : word;
                            }).join(' ');
                        } else if (wholeWord) {
                            // Highlight whole word matches
                            const escapedSearch = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                            const regex = new RegExp(`\\b${escapedSearch}\\b`, caseSensitive ? 'g' : 'gi');
                            value = value.replace(regex, match => `<span class="highlight">${match}</span>`);
                        } else {
                            // Highlight substring matches
                            const regex = new RegExp(searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), caseSensitive ? 'g' : 'gi');
                            value = value.replace(regex, match => `<span class="highlight">${match}</span>`);
                        }
                    }
                    
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            tbody.innerHTML = html;
        }
        
        function updateCounts(count) {
            document.getElementById('totalRecords').textContent = allData.length;
            document.getElementById('searchCount').textContent = count;
            document.getElementById('resultsCount').textContent = count;
        }
        
        function showLoading() {
            document.getElementById('loading').classList.add('active');
            document.querySelector('.table-container').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }
        
        // Event listeners
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchColumn').value = 'all';
            document.getElementById('exactMatch').checked = true;
            document.getElementById('wholeWord').checked = true;
            document.getElementById('caseSensitive').checked = false;
            performSearch();
        });
        
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        // Live search with debouncing
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const term = e.target.value.trim();
            
            if (term.length >= 1) {
                searchTimeout = setTimeout(performSearch, 300);
            } else if (term.length === 0) {
                performSearch();
            }
        });
        
        // Update search when options change
        ['exactMatch', 'wholeWord', 'caseSensitive'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                if (document.getElementById('searchInput').value.trim()) {
                    performSearch();
                }
            });
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>